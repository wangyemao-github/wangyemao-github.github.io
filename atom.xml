<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://wangyemao-github.github.io</id>
    <title>Gridea</title>
    <updated>2021-01-03T12:51:53.894Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://wangyemao-github.github.io"/>
    <link rel="self" href="https://wangyemao-github.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://wangyemao-github.github.io/images/avatar.png</logo>
    <icon>https://wangyemao-github.github.io/favicon.ico</icon>
    <rights>All rights reserved 2021, Gridea</rights>
    <entry>
        <title type="html"><![CDATA[Flink State ä¹‹ KeyedState]]></title>
        <id>https://wangyemao-github.github.io/post/flink-state-zhi-keyedstate/</id>
        <link href="https://wangyemao-github.github.io/post/flink-state-zhi-keyedstate/">
        </link>
        <updated>2021-01-03T02:44:22.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ€»ç»“Flink State ä¸­KeyedStateï¼Œä»¥åŠKeyedStateçš„åº”ç”¨</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ€»ç»“Flink State ä¸­KeyedStateï¼Œä»¥åŠKeyedStateçš„åº”ç”¨</p>
<!-- more -->
<h1 id="keyedstate">KeyedState</h1>
<p>KeyedStateåœ¨KeyedStreamä¸­ä½¿ç”¨ã€‚çŠ¶æ€è·Ÿç‰¹å®šKeyç»‘å®šçš„ï¼Œå³KeyedStreamæµä¸Šçš„æ¯ä¸€ä¸ªKeyå¯¹åº”ä¸€ä¸ªStateå¯¹è±¡ã€‚ã€‚</p>
<h2 id="keyedstate-æ”¯æŒçš„çŠ¶æ€ç±»å‹">KeyedState æ”¯æŒçš„çŠ¶æ€ç±»å‹</h2>
<p>KeyedStateå¯ä»¥ä½¿ç”¨æ‰€æœ‰Flinkæ”¯æŒçš„Stateç±»å‹ã€‚FoldingStateè·ŸReducingStateç±»ä¼¼ï¼Œä½†æ˜¯å·²æ ‡è®°ä¸ºåºŸå¼ƒï¼Œä¸å»ºè®®å†ä½¿ç”¨<br>
<img src="https://wangyemao-github.github.io/post-images/1609670108841.png" alt="" loading="lazy"></p>
<h2 id="statedescriptor">StateDescriptor</h2>
<p>å¯¹åº”äºæ¯ä¸€ç±»Stateï¼ŒFlinkå†…éƒ¨éƒ½è®¾è®¡äº†å¯¹åº”çš„<strong>StateDescriptor</strong>çŠ¶æ€æè¿°ã€‚å®ƒæŒ‡å®šäº†çŠ¶æ€çš„ä¸€äº›å±æ€§ï¼ŒåŒ…æ‹¬ï¼šStateåç§°ï¼ŒStateä¸­ç±»å‹ä¿¡æ¯ï¼Œåºåˆ—åŒ–/ååºåˆ—åŒ–å™¨ï¼ŒStateç”Ÿå­˜æ—¶é—´ç­‰ã€‚</p>
<h3 id="valuestatedescriptorå®šä¹‰">ValueStateDescriptorå®šä¹‰</h3>
<pre><code class="language-java">ValueStateDescriptor&lt;Tuple2&lt;Long,Long&gt;&gt; descriptor = 
              new ValueStateDescriptor&lt;&gt;(&quot;average&quot;,
                    TypeInformation.of(new TypeHint&lt;Tuple2&lt;Long,Long&gt;&gt;(){}),
                    Tuple2.of(0L,0L));
</code></pre>
<p>ä»£ç ç‰‡æ®µå®šä¹‰äº†ä¸€ä¸ªValueStateDescriptorï¼ŒæŒ‡å®šçŠ¶æ€åç§°ä¸ºâ€œaverageâ€ï¼ŒçŠ¶æ€ç±»å‹ä¸ºTuple2&lt;Long,Long&gt;ï¼Œé»˜è®¤å€¼ä¸ºï¼šTuple2&lt;0L,0L&gt;</p>
<h2 id="ä¸åŒçŠ¶æ€ç±»å‹è¯¦ç»†å¯¹æ¯”">ä¸åŒçŠ¶æ€ç±»å‹è¯¦ç»†å¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>Stateç±»å‹</th>
<th>å­˜å‚¨æ•°æ®ç±»å‹</th>
<th>StateDescriptor</th>
<th>ä½¿ç”¨</th>
<th>æ“ä½œ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ValueState<T></td>
<td>Tç±»å‹çš„å•å€¼çŠ¶æ€</td>
<td>ValueStateDescriptor<T></td>
<td>ValueState<T> getState(ValueStateDescriptor<T>)</td>
<td>æ›´æ–°ï¼šupdate(T);<br>è·å–ï¼šT value();</td>
<td>æ¯ä¸€ä¸ªKeyä¸Tç±»å‹çŠ¶æ€å€¼ç»‘å®š</td>
</tr>
<tr>
<td>ListState<T></td>
<td>Keyä¸Šçš„çŠ¶æ€å€¼ä¸ºä¸€ä¸ªåˆ—è¡¨</td>
<td>ListStateDescriptor<T></td>
<td>ListState<T> getListState(ListStateDescriptor<T>)</td>
<td>è¿½åŠ æ•°æ®ï¼šadd(T)/addAll(List<T>);<br>è·å–çŠ¶æ€æ•°æ®åˆ—è¡¨ï¼šIterable<T> get()</td>
<td></td>
</tr>
<tr>
<td>ReducingState<T></td>
<td>å­˜å‚¨ä¸€ä¸ªTç±»å‹çš„å€¼</td>
<td>ReducingStateDescriptor<T></td>
<td>ReducingState<T> getReducingState(ReducingStateDescriptor<T>)</td>
<td>æ·»åŠ æ•°æ®ï¼šadd(T);</td>
<td>è¿™ç§çŠ¶æ€é€šè¿‡ç”¨æˆ·ä¼ å…¥çš„reduceFunctionï¼Œæ¯æ¬¡è°ƒç”¨addæ–¹æ³•æ·»åŠ å€¼æ—¶ï¼Œä¼šè°ƒç”¨reduceFunctionï¼Œæœ€ååˆå¹¶åˆ°ä¸€ä¸ªå•ä¸€çš„çŠ¶æ€å€¼</td>
</tr>
<tr>
<td>AggregatingState&lt;IN, OUT&gt;</td>
<td>å­˜å‚¨ä¸€ä¸ªå€¼</td>
<td>AggregatingStateDescriptor&lt;IN, ACC, OUT&gt;</td>
<td>AggregatingState&lt;IN, OUT&gt; getAggregatingState(AggregatingStateDescriptor&lt;IN, ACC, OUT&gt;)</td>
<td>æ·»åŠ æ•°æ®ï¼šadd(IN)</td>
<td>èšåˆStateï¼Œä¸ReducingStateä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„èšåˆç±»å‹å¯ä»¥æ˜¯ä¸åŒçš„å…ƒç´ ç±»å‹ã€‚æ¯æ¬¡æ·»åŠ å€¼æ—¶ï¼Œä¼šè°ƒç”¨AggregateFunctionå‡½æ•°è®¡ç®—èšåˆç»“æœ</td>
</tr>
<tr>
<td>MapState&lt;UK, UV&gt;</td>
<td>Map</td>
<td>MapStateDescriptor&lt;UK,UV&gt;</td>
<td>MapState&lt;UK, UV&gt; getMapState(MapStateDescriptor&lt;UK, UV&gt;)</td>
<td>æ·»åŠ ï¼šput(UK,UV)/putAll(UK,UV);<br>è·å–ï¼šUV get(UK);<br>éå†ï¼šIterable&lt;Map.Entry&gt; entries()/Iterator&lt;Map.Entry&gt; iterator();</td>
<td>key-valueç»“æ„æ•°æ®</td>
</tr>
</tbody>
</table>
<h1 id="keyedstateä½¿ç”¨">KeyedStateä½¿ç”¨</h1>
<p>##KeyedStream<br>
KeyedStateåªèƒ½åº”ç”¨äºKeyedStreamï¼Œå¦‚æœä½ æƒ³åœ¨DataStreamä¸Šä½¿ç”¨Keyed Stateï¼Œä½ éœ€è¦é¦–å…ˆæŒ‡å®š<strong>Key</strong>ï¼ŒKeyç”¨äºStateï¼ˆä¹Ÿç”¨äºæµè®°å½•æœ¬èº«ï¼‰çš„åˆ†åŒºã€‚<br>
###æŒ‡å®šKeyçš„æ–¹å¼<br>
DataStreamçš„keyBy()æ–¹æ³•ç”¨äºæŒ‡å®šKeyï¼Œå¹¶å°†DataStreamè½¬æ¢ä¸ºKeyedStreamã€‚å®ƒæœ‰å¦‚ä¸‹å‡ ç§é‡è½½æ–¹æ³•ï¼Œå®˜æ–¹</p>
<blockquote>
<p>KeySelector</p>
<blockquote>
<p>KeyedStream&lt;T, K&gt; keyBy(KeySelector&lt;T, K&gt; key)<br>
é€šè¿‡å®ç°KeySelector Functionä¸­çš„getKey()æ–¹æ³•ï¼Œè‡ªç”±æŒ‡å®šKeyçš„æå–<br>
Tuple Keys<br>
KeyedStream&lt;T, Tuple&gt; keyBy(int... fields)<br>
åº”ç”¨äºæ•°æ®ç±»å‹ä¸ºç®€å•Tupleç±»å‹ï¼Œé€šè¿‡Tupleä¸‹è¡¨ç´¢å¼•æŒ‡å®šKeyï¼Œå½“æŒ‡å®šå¤šä¸ªæ—¶ä¸ºç»„åˆé”®<br>
Expression Keys<br>
KeyedStream&lt;T, Tuple&gt; keyBy(String... fields)<br>
åº”ç”¨äºå¤æ‚çš„Tupleç±»å‹æˆ–POJOç±»å‹ï¼Œå¯¹äºPOJOç±»å‹ï¼ŒStringå‚æ•°ç”¨äºæŒ‡å®šå­—æ®µå</p>
</blockquote>
</blockquote>
<p>Flinkçš„æ•°æ®æ¨¡å‹å¹¶ä¸æ˜¯åŸºäºé”®å€¼å¯¹çš„ã€‚å› æ­¤ï¼ŒKeyedStreamå¹¶ä¸ä¼šå°†ç‰©ç†ä¸Šå°†æ•°æ®å¤„ç†ä¸ºé”®ä½•å€¼ã€‚Keyæ˜¯â€œè™šæ‹Ÿçš„â€ï¼šå®ƒè¢«å®šä¹‰ä¸ºåœ¨å®é™…æ•°æ®ä¸Šç”¨äºæŒ‡å¯¼åˆ†ç»„æ“ä½œçš„å‡½æ•°ã€‚</p>
<p>KeyedStateä¿å­˜åœ¨StateBackendä¸­</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Flink State ä¹‹ Operator State åº”ç”¨]]></title>
        <id>https://wangyemao-github.github.io/post/flink-state-zhi-operator-state-ying-yong/</id>
        <link href="https://wangyemao-github.github.io/post/flink-state-zhi-operator-state-ying-yong/">
        </link>
        <updated>2020-12-29T12:34:38.000Z</updated>
        <summary type="html"><![CDATA[<p>ä¸Šæ–‡å·²ç»è¯´åˆ°ï¼šFlinkä¸­ï¼Œæ ¹æ®æ•°æ®é›†æ˜¯å¦æ ¹æ®Keyè¿›è¡Œåˆ†åŒºï¼Œå°†çŠ¶æ€åˆ†ä¸ºKeyde Stateå’ŒOperator Stateä¸¤ç§ç±»å‹ã€‚æœ¬æ–‡ä¸»è¦å…³æ³¨Operator Stateä»¥åŠOperator Stateç›¸å…³åº”ç”¨ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä¸Šæ–‡å·²ç»è¯´åˆ°ï¼šFlinkä¸­ï¼Œæ ¹æ®æ•°æ®é›†æ˜¯å¦æ ¹æ®Keyè¿›è¡Œåˆ†åŒºï¼Œå°†çŠ¶æ€åˆ†ä¸ºKeyde Stateå’ŒOperator Stateä¸¤ç§ç±»å‹ã€‚æœ¬æ–‡ä¸»è¦å…³æ³¨Operator Stateä»¥åŠOperator Stateç›¸å…³åº”ç”¨ã€‚</p>
<!-- more -->  
<h1 id="operator-state">Operator State</h1>
<p>Operator Stateï¼Œä¹Ÿç§°ä½œnon-keyed Stateã€‚æ¯ä¸€ä¸ªOperator Stateä¸ä¸€ä¸ªå¹¶è¡Œçš„Operatorå®ä¾‹ç»‘å®šï¼Œæ¯ä¸ªOperatorå®ä¾‹ä¸­éƒ½æŒæœ‰æ‰€æœ‰æ•°æ®å…ƒç´ çš„ä¸€éƒ¨åˆ†çŠ¶æ€ã€‚<br>
åœ¨å…¸å‹çš„Flinkæœ‰çŠ¶æ€åº”ç”¨ä¸­ï¼Œå¹¶ä¸éœ€è¦ç”¨åˆ°Operator Stateã€‚å®ƒä¸»è¦æ˜¯ä½œä¸ºä¸€ç§ç‰¹æ®Šç±»å‹çš„çŠ¶æ€ï¼Œåº”ç”¨äºSource/Sinkçš„å®ç°ï¼Œä»¥åŠåœ¨æ²¡æœ‰é”®è¿›è¡ŒçŠ¶æ€åˆ†åŒºçš„åœºæ™¯ã€‚</p>
<h2 id="æ”¯æŒçš„æ•°æ®ç±»å‹">æ”¯æŒçš„æ•°æ®ç±»å‹</h2>
<p>ç›®å‰Operator Stateåªæ”¯æŒä½¿ç”¨<strong>ListState</strong></p>
<h2 id="é‡åˆ†å¸ƒæœºåˆ¶">é‡åˆ†å¸ƒæœºåˆ¶</h2>
<p>å½“å¹¶è¡Œåº¦æ”¹å˜æ—¶ï¼ŒOperator Stateæ¥å£æ”¯æŒåœ¨å¹¶è¡Œçš„æ“ä½œå®ä¾‹ä¹‹é—´é‡åˆ†å¸ƒStateï¼Œå¹¶ä¸”æ”¯æŒå¤šç§é‡åˆ†å¸ƒæ–¹æ¡ˆï¼š</p>
<ul>
<li>å‡åŒ€é‡åˆ†å¸ƒï¼šæ¯ä¸€ä¸ªå¹¶è¡ŒOperatoréƒ½è¿”å›ä¸€ä¸ªçŠ¶æ€åˆ—è¡¨ï¼ˆListï¼‰ã€‚æ•´ä¸ªçŠ¶æ€ç©ºé—´é€»è¾‘ä¸Šå°±æ˜¯æ‰€æœ‰çŠ¶æ€åˆ—è¡¨çš„å¹¶é›†ã€‚åœ¨æ¢å¤/é‡åˆ†å¸ƒé˜¶æ®µï¼Œæ•´ä¸ªçŠ¶æ€åˆ—è¡¨æ ¹æ®å¹¶è¡Œæ“ä½œæ•°ç›®å‡åˆ†ä¸ºå­çŠ¶æ€åˆ—è¡¨ã€‚æ¯ä¸€ä¸ªå¹¶è¡Œæ“ä½œåˆ†é…ä¸€ä¸ªå­çŠ¶æ€åˆ—è¡¨ï¼Œå­çŠ¶æ€åˆ—è¡¨å¯èƒ½ä¸ºç©ºï¼Œä¹Ÿå¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€‚</li>
<li>åˆå¹¶é‡åˆ†å¸ƒï¼šè¿™ç§æ–¹å¼å°†çŠ¶æ€çš„åˆ’åˆ†äº¤ç»™ç”¨æˆ·ï¼Œä¸å‡åŒ€é‡åˆ†å¸ƒæ–¹å¼ç›¸æ¯”å…·æœ‰æ›´å¥½çš„çµæ´»æ€§ã€‚åœ¨æ¢å¤/é‡åˆ†å¸ƒé˜¶æ®µï¼Œæ¯ä¸€ä¸ªå¹¶è¡Œæ“ä½œéƒ½è·å¾—äº†å®Œæ•´çš„ä¸€ä»½çŠ¶æ€åˆ—è¡¨ã€‚å¦‚æœçŠ¶æ€åŸºæ•°å¾ˆå¤§ï¼Œä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚å› ä¸ºCheckpoint å…ƒæ•°æ®ä¼šå­˜å‚¨æ¯ä¸ªåˆ—è¡¨é¡¹çš„åç§»é‡ï¼Œè¿™å¯èƒ½å¯¼è‡´RPCå¸§å¤§å°æˆ–å†…å­˜ä¸è¶³é”™è¯¯ã€‚</li>
</ul>
<h1 id="operator-state-åº”ç”¨">Operator State åº”ç”¨</h1>
<h2 id="å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ªçŠ¶æ€state">å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ªçŠ¶æ€(State)</h2>
<p>åœ¨Flinkä¸­ï¼Œä½¿ç”¨çŠ¶æ€æè¿°<strong>StateDescriptor</strong>æ¥åˆå§‹åŒ–Stateï¼Œå®ƒåŒ…å«äº†Stateçš„åç§°ä»¥åŠä¿å­˜çš„Stateå€¼çš„ç±»å‹ä¿¡æ¯</p>
<pre><code class="language-java">ListStateDescriptor&lt;Tuple2&lt;String, Integer&gt;&gt; descriptor =
    new ListStateDescriptor&lt;&gt;(
        &quot;buffered-elements&quot;,
        TypeInformation.of(new TypeHint&lt;Tuple2&lt;String,Integer&gt;&gt;() {}));
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­å®šä¹‰äº†ä¸€ä¸ªStateåç§°ä¸ºï¼šbuffered-elementsï¼ŒStateå€¼ç±»å‹ä¸ºï¼šTuple2&lt;String,Integer&gt; çš„çŠ¶æ€æè¿°<br>
##CheckpointedFunction<br>
è¦ä½¿ç”¨Operator Stateï¼Œæœ‰çŠ¶æ€çš„å‡½æ•°éœ€è¦å®ç°<strong>CheckpointedFunction</strong>æ¥å£ï¼Œè¯¥æ¥å£éœ€è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-java">void snapshotState(FunctionSnapshotContext context) throws Exception;
void initializeState(FunctionInitializationContext context) throws Exception;
</code></pre>
<p>æ— è®ºä»€ä¹ˆæ—¶å€™æ‰§è¡Œcheckpointï¼Œéƒ½ä¼šè°ƒç”¨snapshotState()æ–¹æ³•ã€‚å› æ­¤è¯¥æ–¹æ³•ä¸»è¦å®šä¹‰çŠ¶æ€çš„å¿«ç…§ä¿å­˜é€»è¾‘ï¼›ç›¸åº”åœ°ï¼Œæ¯å½“ç”¨æˆ·å®šä¹‰çš„å‡½æ•°è¢«åˆå§‹åŒ–æ—¶ï¼ˆæ— è®ºæ˜¯å‡½æ•°é¦–æ¬¡åˆå§‹åŒ–ï¼Œè¿˜æ˜¯å‡½æ•°å®é™…ä¸Šä»æ›´æ—©ä¸€ä¸ªæ£€æŸ¥ç‚¹æ¢å¤ï¼‰ï¼Œéƒ½ä¼šè°ƒç”¨initializeState()æ–¹æ³•ã€‚å› æ­¤ï¼ŒinitializeState()ä¸ä»…æ˜¯ä¸åŒç±»å‹çŠ¶æ€åˆå§‹åŒ–çš„åœ°æ–¹ï¼Œè€Œä¸”ä¹ŸåŒ…å«äº†çŠ¶æ€æ¢å¤çš„é€»è¾‘ã€‚</p>
<h2 id="sinkfunction-sample">SinkFunction Sample</h2>
<pre><code class="language-java">public class BufferingSink implements SinkFunction&lt;Tuple2&lt;String, Integer&gt;&gt;,            CheckpointedFunction {

    private final int threshold;

    private transient ListState&lt;Tuple2&lt;String, Integer&gt;&gt; checkpointedState;

    private List&lt;Tuple2&lt;String, Integer&gt;&gt; bufferedElements;

    public BufferingSink(int threshold) {
        this.threshold = threshold;
        this.bufferedElements = new ArrayList&lt;&gt;();
    }

    @Override
    public void invoke(Tuple2&lt;String, Integer&gt; value, Context contex) throws Exception {
        bufferedElements.add(value);
        if (bufferedElements.size() == threshold) {
            for (Tuple2&lt;String, Integer&gt; element: bufferedElements) {
                // send it to the sink
            }
            bufferedElements.clear();
        }
    }

    @Override
    public void snapshotState(FunctionSnapshotContext context) throws Exception {
        checkpointedState.clear();
        for (Tuple2&lt;String, Integer&gt; element : bufferedElements) {
            checkpointedState.add(element);
        }
    }

    @Override
    public void initializeState(FunctionInitializationContext context) throws Exception {
        ListStateDescriptor&lt;Tuple2&lt;String, Integer&gt;&gt; descriptor =
            new ListStateDescriptor&lt;&gt;(
                &quot;buffered-elements&quot;,
                TypeInformation.of(new TypeHint&lt;Tuple2&lt;String, Integer&gt;&gt;() {}));

        checkpointedState = context.getOperatorStateStore().getListState(descriptor);

        if (context.isRestored()) {
            for (Tuple2&lt;String, Integer&gt; element : checkpointedState.get()) {
                bufferedElements.add(element);
            }
        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Flink State ä¹‹æ€»ä½“ä»‹ç»]]></title>
        <id>https://wangyemao-github.github.io/post/flink-state-zong-ti-jie-shao/</id>
        <link href="https://wangyemao-github.github.io/post/flink-state-zong-ti-jie-shao/">
        </link>
        <updated>2020-12-29T08:09:21.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦å¯¹Flink Stateè¿›è¡Œæ•´ä½“ä»‹ç»ï¼ŒåŒ…æ‹¬æœ‰çŠ¶æ€çš„æµå¼è®¡ç®—æ¡†æ¶Flinkä¸ä¼ ç»Ÿæµå¼è®¡ç®—æ¡†æ¶çš„åŒºåˆ«ï¼ŒFlink Stateç±»å‹åˆ’åˆ†ï¼ŒStateå­˜å‚¨ä¸ç®¡ç†ä»¥åŠåŠ¨æ€æ‰©å®¹ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦å¯¹Flink Stateè¿›è¡Œæ•´ä½“ä»‹ç»ï¼ŒåŒ…æ‹¬æœ‰çŠ¶æ€çš„æµå¼è®¡ç®—æ¡†æ¶Flinkä¸ä¼ ç»Ÿæµå¼è®¡ç®—æ¡†æ¶çš„åŒºåˆ«ï¼ŒFlink Stateç±»å‹åˆ’åˆ†ï¼ŒStateå­˜å‚¨ä¸ç®¡ç†ä»¥åŠåŠ¨æ€æ‰©å®¹ã€‚</p>
<!-- more -->
<h1 id="ä¸€-æœ‰çŠ¶æ€æµè®¡ç®—ä»‹ç»">ä¸€ã€æœ‰çŠ¶æ€æµè®¡ç®—ä»‹ç»</h1>
<h2 id="ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—">ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—</h2>
<p>è®¡ç®—ä»»åŠ¡çš„ç»“æœä¸ä»…ä»…ä¾èµ–äºè¾“å…¥ï¼Œè¿˜ä¾èµ–äºå®ƒçš„å½“å‰çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œå¾ˆå¸¸è§çš„ä¸šåŠ¡åœºæ™¯wordCountï¼Œåœ¨è®¡ç®—çš„è¿‡ç¨‹ä¸­è¦ä¸æ–­åœ°æŠŠè¾“å…¥ç´¯åŠ åˆ°countä¸Šå»ï¼Œé‚£ä¹ˆ<strong>è¿™é‡Œçš„countå°±æ˜¯ä¸€ä¸ªstate</strong><br>
<img src="https://wangyemao-github.github.io/post-images/1609229474736.jpg" alt="" loading="lazy"><br>
FlinkåŸºäºç”¨æˆ·å®šä¹‰ä»£ç å¯¹åˆ°æ¥çš„æ•°æ®è¿›è¡Œè½¬æ¢æ“ä½œï¼Œå¤„ç†è¿‡ç¨‹ä¸­ä¸ä»…ä¾èµ–ç”¨æˆ·å®šä¹‰ç®—å­ï¼Œè¿˜ä¼šæ¶‰åŠStateæ•°æ®çš„è¯»å†™æ“ä½œã€‚è¿™äº›Stateæ•°æ®ä¼šå­˜å‚¨åœ¨æœ¬åœ°çš„State backendä¸­ï¼Œåœ¨Checkpointçš„æ—¶å€™æŒä¹…åŒ–åˆ°é…ç½®çš„Checkpoint ç›®å½•</p>
<h2 id="ä¼ ç»Ÿæµå¼æ¡†æ¶">ä¼ ç»Ÿæµå¼æ¡†æ¶</h2>
<p>åœ¨ä¹‹å‰çš„å®æ—¶è®¡ç®—æ¡†æ¶â€”Sparkè¿›è¡Œæµå¼æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæµå¼è®¡ç®—é€šè¿‡å°†æºæºä¸æ–­çš„æ•°æ®åˆ‡åˆ†ä¸ºä¸€ä¸ªä¸ªå¾ˆå°çš„æ—¶é—´é—´éš”æ‰¹å—ï¼Œç„¶åé’ˆå¯¹æ¯ä¸€ä¸ªå¾®æ‰¹å—è¿›è¡Œæ•°æ®è®¡ç®—ã€‚å®ƒå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æµå¼å¤„ç†ã€‚æ¯ä¸€ä¸ªå¾®æ‰¹ï¼Œåªéœ€è¦ä¿å­˜æœ€ç»ˆçš„è®¡ç®—ç»“æœï¼Œå› æ­¤ï¼Œå®ƒå¯¹äºStateçš„éœ€æ±‚è¿˜æ˜¯æ¯”è¾ƒå°çš„ã€‚</p>
<p>å®é™…ä¸Šï¼Œæµå¼è®¡ç®—å¯¹Stateçš„è¦æ±‚æ˜¯éå¸¸é«˜çš„ã€‚å› ä¸ºæµç³»ç»Ÿä¸­è¾“å…¥æ˜¯ä¸€ä¸ªæ— é™åˆ¶çš„æµï¼Œéœ€è¦ä¿è¯å¾ˆé•¿ä¸€æ®µæ—¶é—´æŒç»­ä¸é—´æ–­è¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å°±éœ€è¦å¾ˆå¥½åœ°å°†çŠ¶æ€æ•°æ®ç®¡ç†èµ·æ¥ã€‚ä¼ ç»Ÿçš„æµå¼è®¡ç®—æ¡†æ¶ç¼ºä¹å¯¹Stateçš„æœ‰æ•ˆæ”¯æŒï¼š</p>
<ul>
<li>çŠ¶æ€æ•°æ®çš„å­˜å‚¨å’Œè®¿é—®</li>
<li>çŠ¶æ€æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤</li>
<li>çŠ¶æ€æ•°æ®çš„åˆ’åˆ†å’ŒåŠ¨æ€æ‰©å®¹</li>
</ul>
<h2 id="flinkæä¾›äº†ä¸°å¯Œçš„çŠ¶æ€è®¿é—®å’Œé«˜æ•ˆçš„å®¹é”™æœºåˆ¶">Flinkæä¾›äº†ä¸°å¯Œçš„çŠ¶æ€è®¿é—®å’Œé«˜æ•ˆçš„å®¹é”™æœºåˆ¶</h2>
<ul>
<li>å¤šç§æ•°æ®ç±»å‹ï¼šValueã€Listã€Mapã€Reducingã€Foldingã€Aggregating</li>
<li>å¤šç§åˆ’åˆ†æ–¹å¼ï¼š Keyed Stateã€Operator State</li>
<li>å¤šç§å­˜å‚¨æ ¼å¼ï¼š MemoryStateBackendã€FsStateBackendã€RocksDBStateBackend</li>
<li>é«˜æ•ˆçš„å¤‡ä»½å’Œæ¢å¤ï¼šæä¾›ExactlyOnceä¿è¯ã€å¢é‡åŠå¼‚æ­¥å¤‡ä»½æœ¬åœ°æ¢å¤</li>
</ul>
<h1 id="äºŒ-flink-state-ç±»åˆ«">äºŒã€Flink State ç±»åˆ«</h1>
<p>Flinkä¸­ï¼ŒStateæŒ‰ç…§æ˜¯å¦æœ‰Keyåˆ’åˆ†ä¸ºKeyed Stateå’ŒOperator State</p>
<h2 id="keyed-state">Keyed State</h2>
<p><strong>Keyed State</strong>åœ¨Keyed Streamä¸­ä½¿ç”¨ã€‚çŠ¶æ€æ˜¯è·Ÿç‰¹å®šçš„Keyç»‘å®šçš„ï¼Œå³Keyed Streamæµä¸Šçš„æ¯ä¸€ä¸ªKeyå¯¹åº”ä¸€ä¸ªStateå¯¹è±¡ã€‚</p>
<h2 id="operator-state">Operator State</h2>
<p><strong>Operator State</strong>(non-keyed state)è·Ÿä¸€ä¸ªç‰¹å®šæ“ä½œçš„å¹¶è¡Œå®ä¾‹ç»‘å®šï¼Œæ•´ä¸ªæ“ä½œåªå¯¹åº”ä¸€ä¸ªStateã€‚å…¸å‹çš„Operator Stateåº”ç”¨åœºæ™¯å°±æ˜¯Kafka Source Connectorï¼Œkafka consumerçš„æ¯ä¸€ä¸ªå¹¶è¡Œå®ä¾‹éƒ½ç»´æŠ¤äº†topic partitionä¸offsetsçš„æ˜ å°„å…³ç³»ä½œä¸ºå®ƒçš„Operator Stateã€‚<br>
<strong>Broadcast State</strong>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Operator Stateã€‚å®ƒçš„å¼•å…¥æ˜¯ä¸ºäº†æ”¯æŒä¸€ä¸ªæµçš„è®°å½•éœ€è¦è¢«å¹¿æ’­åˆ°ä¸‹æ¸¸çš„æ‰€æœ‰å¹¶è¡Œä»»åŠ¡çš„åœºæ™¯ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸­ï¼Œå®ƒä»¬è¢«ç”¨æ¥åœ¨æ‰€æœ‰çš„å¹¶è¡Œä»»åŠ¡ä¸­ç»´æŠ¤ç›¸åŒçš„çŠ¶æ€ã€‚ç„¶åï¼Œå¯ä»¥åœ¨å¤„ç†ç¬¬äºŒä¸ªæµçš„è®°å½•æ—¶è®¿é—®è¿™ä¸ªçŠ¶æ€ã€‚broadcast stateä¸operator stateçš„å…¶ä»–åŒºåˆ«ï¼š</p>
<ol>
<li>çŠ¶æ€çš„æ•°æ®ç±»å‹ä¸ºMapæ ¼å¼</li>
<li>å®ƒä»…åœ¨å…·æœ‰ä¸¤ä¸ªè¾“å…¥æµçš„ç‰¹å®šæ“ä½œä¸Šå¯ç”¨ï¼Œä¸€ä¸ªè¾“å…¥æµä¸ºbroadcasted stream ï¼Œä¸€ä¸ªè¾“å…¥æµä¸ºnon-broadcasted</li>
<li>è¿™äº›æ“ä½œå¯ä»¥å®šä¹‰å¤šä¸ªå…·æœ‰ä¸åŒåç§°çš„broadcast state</li>
</ol>
<p><strong>è¯¦ç»†å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>å¯¹æ¯”ç»´åº¦</th>
<th>Keyed State</th>
<th>Operator State</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½¿ç”¨åœºæ™¯</td>
<td>åªèƒ½ç”¨äºKeyedStreamä¸Šçš„ç®—å­</td>
<td>å¯ä»¥ç”¨äºæ‰€æœ‰çš„ç®—å­ï¼Œå¸¸ç”¨äºSourceï¼Œä¾‹å¦‚FlinkKafkaConsumer</td>
</tr>
<tr>
<td>åº”ç”¨</td>
<td>é€šè¿‡RuntimeContextè®¿é—®ï¼Œæ“ä½œå‡½æ•°éœ€è¦å®ç°RichFunctionæ¥å£</td>
<td>å®ç°CheckpointedFunctionæˆ–ListCheckpointedæ¥å£</td>
</tr>
<tr>
<td>æ˜¯å¦éœ€è¦æ‰‹åŠ¨å£°æ˜å¿«ç…§(snapshot)å’Œæ¢å¤ï¼ˆrestore)æ–¹æ³•</td>
<td>ç”±backendè‡ªè¡Œå®ç°ï¼Œå¯¹ç”¨æˆ·é€æ˜</td>
<td>éœ€è¦æ‰‹åŠ¨å®ç°snapshotå’Œrestoreæ–¹æ³•</td>
</tr>
<tr>
<td>æ”¯æŒæ•°æ®æ¥å£</td>
<td>åŒ…æ‹¬ï¼šValueStateã€ListStateã€ReducingStateã€AggregatingStateã€MapState</td>
<td>ListStateã€‚ç‰¹åˆ«è¯´æ˜ï¼šBroadcast State æ˜¯MapStateç±»å‹</td>
</tr>
<tr>
<td>æ˜¯å¦å­˜åœ¨å½“å‰å¤„ç†çš„ keyï¼ˆcurrent keyï¼‰</td>
<td>keyed stateçš„valueæ€»æ˜¯ä¸ä¸€ä¸ªcurrent keyå¯¹åº”ã€‚ä¸€ä¸ªOperatorå®ä¾‹å¤„ç†å¤šä¸ªkeyï¼Œè®¿é—®ç›¸åº”çš„å¤šä¸ªState</td>
<td>æ— å½“å‰keyæ¦‚å¿µã€‚ä¸€ä¸ªOperatorå®ä¾‹å¯¹åº”ä¸€ä¸ªState</td>
</tr>
<tr>
<td>å¹¶å‘æ”¹å˜æ—¶Stateé‡åˆ†å¸ƒ</td>
<td>åŸºäºKey-Groupï¼ŒStateéšç€Keyåœ¨å®ä¾‹é—´è¿ç§»</td>
<td>å¹¶å‘æ”¹å˜æ—¶ï¼Œæœ‰å¤šç§é‡æ–°åˆ†é…æ–¹å¼å¯é€‰ï¼šå‡åŒ€åˆ†é…ï¼›åˆå¹¶åæ¯ä¸ªå®ä¾‹éƒ½å¾—åˆ°å…¨é‡çŠ¶æ€</td>
</tr>
<tr>
<td>å­˜å‚¨å¯¹è±¡æ˜¯å¦ on heap</td>
<td>keyed state backend æœ‰on-heapå’Œoff-heap(RocksDB)çš„å¤šç§å®ç°</td>
<td>ç›®å‰operator state backendä»…æœ‰ä¸€ç§on-heapçš„å®ç°</td>
</tr>
<tr>
<td>çŠ¶æ€æ•°æ®å¤§å°ã€è¿™åªæ˜¯ä¸ªç»éªŒåˆ¤æ–­ï¼Œä¸æ˜¯ç»å¯¹çš„åˆ¤æ–­åŒºåˆ†æ ‡å‡†ã€‘</td>
<td>ä¸€èˆ¬è€Œè¨€ï¼ŒKeyed stateè§„æ¨¡çš„ç›¸å¯¹æ¯”è¾ƒå¤§çš„</td>
<td>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬è®¤ä¸ºoperator stateçš„æ•°æ®è§„æ¨¡æ˜¯æ¯”è¾ƒå°çš„</td>
</tr>
</tbody>
</table>
<h1 id="ä¸‰-flink-stateå­˜å‚¨å’Œç®¡ç†">ä¸‰ã€Flink Stateå­˜å‚¨å’Œç®¡ç†</h1>
<h2 id="state-backend-åˆ†ç±»">State Backend åˆ†ç±»</h2>
<p>Stateåœ¨å†…éƒ¨å¦‚ä½•è¡¨è¿°ï¼Œcheckpointæ—¶ï¼ŒStateå¦‚ä½•ä»¥åŠåœ¨å“ªé‡Œè¿›è¡ŒæŒä¹…åŒ–ï¼Œä¾èµ–äºé€‰æ‹©çš„State Backendã€‚Flinké»˜è®¤æ†ç»‘äº†ä¸‰ç±»State Backendsï¼šMemoryStateBackendã€FsStateBackendã€RocksDBStateBackendã€‚åœ¨æœªé…ç½®çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå°†é»˜è®¤ä½¿ç”¨MemoryStateBackendã€‚</p>
<p><strong>è¯¦ç»†åŒºåˆ«ï¼š</strong><br>
<img src="https://wangyemao-github.github.io/post-images/1609232674288.jpg" alt="" loading="lazy"></p>
<table>
<thead>
<tr>
<th>State Backend ç±»å‹</th>
<th>Stateå­˜å‚¨</th>
<th>Checkpointæ—¶å­˜å‚¨</th>
<th>å¿«ç…§æ–¹å¼</th>
<th>æ˜¯å¦æ”¯æŒå¢é‡Checkpoint</th>
<th>é™åˆ¶</th>
<th>ä½¿ç”¨åœºæ™¯</th>
<th>æ¨èè®¾ç½®</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>MemoryStateBackend</td>
<td>TaskManagerå†…å­˜</td>
<td>JobManagerå†…å­˜</td>
<td>é»˜è®¤å¼‚æ­¥æ–¹å¼</td>
<td>å¦</td>
<td>1. å•ä¸ªStateé»˜è®¤é™åˆ¶ä¸º5MBï¼Œå½“ç„¶è¿™ä¸ªå€¼å¯ä»¥åœ¨åˆ›å»ºstate backendæ—¶è°ƒæ•´<br>2. ä½†æ˜¯Max Stateæœ€å¤§ä¸èƒ½è¶…è¿‡akka frameçš„size (é»˜è®¤10M)<br>3. èšåˆçš„Stateæ€»å¤§å°è¦å°äºJobManagerå†…å­˜å¤§å°</td>
<td>1. æœ¬åœ°å¼€å‘å’Œdebugging<br>2. éœ€è¦å­˜å‚¨å¾ˆå°‘é‡çŠ¶æ€çš„ä½œä¸š<br>3. ä¸æ¨èç”Ÿäº§åœºæ™¯</td>
<td>å°†managed memoryè®¾ç½®ä¸º0.ç¡®ä¿æœ€å¤§é‡åœ°ä½¿ç”¨åˆ†é…å†…å­˜ç»™ç”¨æˆ·ä½œä¸š</td>
<td>1. Stateæ•°æ®ä½œä¸ºJavaå †å¯¹è±¡åœ¨æœ¬åœ°ï¼ˆTaskManagerï¼‰å­˜å‚¨<br>2. åœ¨Checkpointæ—¶ï¼Œstate backendä¼šå¿«ç…§çŠ¶æ€æ•°æ®ï¼Œä½œä¸ºcheckpointç¡®è®¤æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å‘é€ç»™JobManagerã€‚åœ¨JobManagerä¸Šï¼ŒçŠ¶æ€æ•°æ®ä¹Ÿæ˜¯åœ¨Java å †ä¸Šå­˜å‚¨çš„</td>
</tr>
<tr>
<td>FsStateBackend</td>
<td>TaskManagerå†…å­˜</td>
<td>å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼ˆæœ¬åœ°ç›®å½•æˆ–HDFSç›®å½•ï¼‰</td>
<td>é»˜è®¤å¼‚æ­¥æ–¹å¼</td>
<td>å¦</td>
<td>1.å•Taskmanagerä¸Šçš„Stateæ€»é‡ä¸è¶…è¿‡å®ƒçš„å†…å­˜<br>2.æ€»å¤§å°ä¸è¶…è¿‡é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿå®¹é‡</td>
<td>1.å¤§çŠ¶æ€ä½œä¸šï¼Œé•¿çª—å£ï¼Œå¤§key/value çŠ¶æ€<br>2.é«˜å¯ç”¨è®¾ç½®<br>3.ç”Ÿäº§åœºæ™¯</td>
<td>åŒä¸Š</td>
<td>1.åœ¨TaskManagerçš„å†…å­˜ä¸­ï¼Œå­˜å‚¨æ­£åœ¨ä½¿ç”¨çš„Stateæ•°æ®<br>2. Checkpointingæ—¶ï¼Œstate backendå°†çŠ¶æ€å¿«ç…§å†™æ–‡ä»¶åˆ°é…ç½®æ–‡ä»¶ç³»ç»Ÿå’Œç›®å½•ä¸­ã€‚æœ€å°åŒ–çš„å…ƒæ•°æ®å­˜å‚¨åœ¨JobManagerçš„å†…å­˜ã€çŠ¶æ€æ•°æ®å­˜å‚¨çš„è·¯å¾„ã€‘ï¼ˆé«˜å¯ç”¨æ¨¡å¼ï¼Œå­˜å‚¨å…ƒæ•°æ®åœ¨å…ƒæ•°æ®checkpointè·¯å¾„ï¼‰</td>
</tr>
<tr>
<td>RocksDBStateBackend</td>
<td>TaskManagerä¸Šçš„KVæ•°æ®åº“(RocksDB)ã€å®é™…ä½¿ç”¨å†…å­˜+ç£ç›˜ã€‘</td>
<td>å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼ˆæœ¬åœ°ç›®å½•æˆ–HDFSç›®å½•ï¼‰</td>
<td>æ€»æ˜¯å¼‚æ­¥</td>
<td>æ˜¯</td>
<td>1.å•TaskManagerä¸Šçš„Stateä¸è¶…è¿‡å®ƒçš„å†…å­˜+ç£ç›˜<br>2.å•Keyæœ€å¤§2G<br>3.æ€»å¤§å°ä¸è¶…è¿‡é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿå®¹é‡</td>
<td>1.å¤§çŠ¶æ€ä½œä¸šï¼Œé•¿çª—å£ï¼Œå¤§key/value çŠ¶æ€<br>2.é«˜å¯ç”¨è®¾ç½®<br>3.ç”Ÿäº§åœºæ™¯</td>
<td></td>
<td>1.RocksDBStateBackendåœ¨RocksDBæ•°æ®åº“ä¸­ä¿å­˜æ­£åœ¨ä½¿ç”¨çš„çŠ¶æ€æ•°æ®ï¼Œé»˜è®¤å­˜å‚¨åœ¨TaskManagerçš„æ•°æ®ç›®å½•<br>2.åœ¨checkpointingæ—¶ï¼Œæ•´ä¸ªRocksDBæ•°æ®åº“å°†è¢«å¿«ç…§åˆ°é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿæˆ–ç›®å½•ã€‚æœ€å°åŒ–çš„å…ƒæ•°æ®å­˜å‚¨åœ¨JobManagerçš„å†…å­˜ä¸­ï¼ˆé«˜å¯ç”¨æ¨¡å¼ï¼Œå­˜å‚¨åœ¨å…ƒæ•°æ®checkpointç›®å½•ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>å…³äºRocksDBStateBackendçš„ç‰¹åˆ«è¯´æ˜ï¼š</strong></p>
<ol>
<li>è¿™ç§æ–¹å¼å¯ä»¥ç»´æŒçš„çŠ¶æ€é‡åªå—é™äºå¯ç”¨çš„ç£ç›˜ç©ºé—´ã€‚ä¸FsStateBackendå°†stateå­˜å‚¨åœ¨å†…å­˜ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼å…è®¸ä¿ç•™æ›´å¤§çš„state</li>
<li>ä½†æ˜¯ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œå¯ä»¥è·å–çš„æœ€å¤§ååé‡å°†æ¯”FsStateBackendæ–¹å¼çš„ä½</li>
<li>æ‰€æœ‰å¯¹backendçš„read/writeéƒ½éœ€è¦é€šè¿‡åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œä»¥å­˜å‚¨/è·å–çŠ¶æ€å¯¹è±¡ã€‚è¿™ç§æ–¹å¼ä¸åŸºäºå †çš„å­˜å‚¨æ–¹å¼ä»£ä»·æ›´é«˜</li>
</ol>
<h2 id="state-backendé…ç½®">State Backendé…ç½®</h2>
<ul>
<li>é…ç½®é»˜è®¤State Backend</li>
</ul>
<blockquote>
<p>flink-conf.yml<br>
state.backend: ã€å¯èƒ½çš„å–å€¼ï¼šjobmanager(MemoryStateBackend)ã€fileSystem(FsStateBackend)ã€rocksdb(RocksDBStateBackend)ã€æˆ–è€…å®ç°äº†state backend factory StateBackendFactoryçš„å…¨é™å®šç±»åï¼ˆorg.apache.flink.contrib.streaming.state.RocksDBStateBackendFactoryï¼‰ã€‘<br>
state.checkpoints.dir:å®šä¹‰backendå†™å¿«ç…§æ•°æ®å’Œå…ƒæ•°æ®æ–‡ä»¶çš„ç›®å½•</p>
</blockquote>
<ul>
<li>per-job è®¾ç½®State Backend</li>
</ul>
<blockquote>
<p>StreamExecutionEnvironment</p>
</blockquote>
<pre><code class="language-java">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
env.setStateBackend(new FsStateBackend(&quot;hdfs://namenode:40010/flink/checkpoints&quot;));
</code></pre>
<h1 id="å››-flink-state-åˆ’åˆ†å’ŒåŠ¨æ€æ‰©å®¹">å››ã€Flink State åˆ’åˆ†å’ŒåŠ¨æ€æ‰©å®¹</h1>
<h2 id="state-åˆ’åˆ†">State åˆ’åˆ†</h2>
<ul>
<li>å¯¹äºOperator Stateç±»å‹ï¼Œæ¯ä¸€ä¸ªå¹¶è¡Œçš„Operatorå®ä¾‹å¯¹åº”ä¸€ä¸ªState</li>
<li>å¯¹äºKeyed Stateç±»å‹ï¼Œæ¯ä¸€ä¸ªCurrent Keyå¯¹åº”ä¸€ä¸ªState</li>
</ul>
<h2 id="state-åŠ¨æ€æ‰©å®¹">State åŠ¨æ€æ‰©å®¹</h2>
<p><strong>Operator Stateç±»å‹</strong><br>
<img src="https://wangyemao-github.github.io/post-images/1609232700062.jpg" alt="" loading="lazy"></p>
<ul>
<li>ListStateï¼šå¹¶å‘åº¦æ”¹å˜çš„æ—¶å€™ï¼Œä¼šå°†å¹¶å‘å®ä¾‹ä¸Šçš„ListStateéƒ½åˆå¹¶åˆ°ä¸€ä¸ªæ–°çš„Listï¼Œç„¶åå‡åŒ€åˆ†é…åˆ°å˜æ›´åçš„å¹¶å‘Taskä¸Š</li>
<li>UnionListStateï¼šæ¯ä¸€ä¸ªå¹¶å‘Taskéƒ½ä¼šæ‹¿åˆ°å…¨é‡çš„ListState</li>
<li>BroadcastStateï¼šæ¯ä¸ªå¹¶å‘Taskä¸Šçš„Stateéƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå› æ­¤ï¼Œå½“å¢å¤§å¹¶å‘åº¦æ—¶ï¼Œåªéœ€è¦Copyä¸€ä»½Stateåˆ°æ–°Taskå³å¯</li>
</ul>
<p><strong>Keyed Stateç±»å‹</strong><br>
åœ¨å¹¶è¡Œåº¦æ”¹å˜æ—¶ï¼Œå¦‚ä½•é‡åˆ†å¸ƒKeyedStateæ•°æ®ï¼Œæœ€ç›´è§‚çš„åšæ³•å°±æ˜¯è®¡ç®—æ¯ä¸ªKeyçš„Hashå€¼ï¼Œå¹¶åŸºäºå¹¶è¡Œåº¦parallelismå–ä½™ã€‚ä¸‹å›¾ä¸ºå½“å¹¶è¡Œåº¦æ”¹å˜æ—¶ï¼ŒåŸºäºHashå–ä½™ç®—æ³•çš„Stateæ•°æ®é‡åˆ†å¸ƒæƒ…å†µï¼š<br>
<img src="https://wangyemao-github.github.io/post-images/1609232708709.png" alt="" loading="lazy"></p>
<p>hashå–ä½™é‡åˆ†å¸ƒç®—æ³•å­˜åœ¨çš„é—®é¢˜ï¼šä¹‹å‰åœ¨å„ä¸ªTaskä¸Šç»´æŠ¤å¥½çš„Stateæ•°æ®ä¼šæ ¹æ®æ–°çš„å¹¶è¡Œåº¦é‡æ–°ç»„ç»‡ï¼ŒStateæ•°æ®åœ¨å„ä¸ªTaskä¹‹é—´ä¼ è¾“ã€‚è¿™å¯¹äºKeyedStateæ•°æ®è¾ƒå¤§æ—¶ï¼Œæ•°æ®é‡æ–°ç»„ç»‡çš„ä»£ä»·ä¼šå¾ˆé«˜ã€‚</p>
<p>ä¸ºäº†è§„é¿ä¸Šè¿°é—®é¢˜ï¼ŒFlinkåŸºäºKey-Group(KeyedStateçš„æœ€å°ç»„ç»‡å•ä½)ç»„ç»‡ã€åˆ†é…KeyedStateã€‚å…·ä½“çš„æ˜ å°„å…³ç³»ä¸º</p>
<pre><code class="language-java">public static int assignToKeyGroup(Object key, int maxParallelism) {
   return computeKeyGroupForKeyHash(key.hashCode(), maxParallelism);
}
public static int computeKeyGroupForKeyHash(int keyHash, int maxParallelism) {
   return MathUtils.murmurHash(keyHash) % maxParallelism;
}
</code></pre>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒKey-Groupæ•°é‡å–å†³äºæœ€å¤§å¹¶è¡Œåº¦ï¼ˆMaxParallismï¼‰ï¼Œåªè¦æœ€å¤§å¹¶è¡Œåº¦ä¸å˜ï¼ŒåŒä¸€ä¸ªkeyå½’å±çš„Key-Groupæ˜¯ä¸ä¼šå˜æ›´çš„ã€‚å¦å¤–ï¼Œæ­¤å¤„åœ¨HashCodeçš„åŸºç¡€ä¸Šåˆè°ƒç”¨murmurHashæ–¹æ³•æ˜¯ä¸ºäº†ä¿è¯å°½é‡æ•£åˆ—ã€‚</p>
<p>åœ¨å¯¹Keyåˆ’åˆ†Key-Groupä¹‹åï¼ŒMaxParallismä¸ªKey-Group åŸºäºKeyGroupRangeåˆ†é…åˆ°parallelismä¸ªå¹¶è¡ŒTaskä¸­ï¼Œæ¯ä¸€ä¸ªå¹¶è¡ŒTaskæŒæœ‰1ä¸ªKeyGroupRangeï¼Œå…·ä½“è®¡ç®—æ–¹æ³•ï¼š</p>
<pre><code>public static KeyGroupRange computeKeyGroupRangeForOperatorIndex(
   int maxParallelism,
   int parallelism,
   int operatorIndex) {
   int start = ((operatorIndex * maxParallelism + parallelism - 1) / parallelism);
   int end = ((operatorIndex + 1) * maxParallelism - 1) / parallelism;
   return new KeyGroupRange(start, end);
}
</code></pre>
<p><strong>ä»¥ä¸€ä¸ªå…·ä½“çš„å®ä¾‹è¯´æ˜ï¼š</strong><br>
å¯¹äºä¸€ä¸ªKey ç©ºé—´=[0,1,2,3,4,5,6,7,8,9] çš„æ•°æ®ï¼ŒMaxParallelism=5ï¼Œå¹¶è¡Œåº¦Parallelismç”±2æ‰©å¤§åˆ°3çš„è¿‡ç¨‹ä¸­ï¼Œ å„ä¸ªå¹¶è¡ŒTaskçš„Key-Groupé‡åˆ†å¸ƒæƒ…å†µä¸ºï¼š<br>
<img src="https://wangyemao-github.github.io/post-images/1609232723011.png" alt="" loading="lazy"><br>
<strong>æ€»ç»“ï¼š</strong></p>
<ol>
<li>åªè¦MaxParallelismä¸å˜ï¼Œæ•´ä¸ªKeyç©ºé—´çš„Key-Groupåˆ’åˆ†æƒ…å†µæ˜¯ä¸ä¼šå˜æ›´çš„</li>
<li>å½“å¹¶è¡Œåº¦å˜æ›´æ—¶ï¼ŒåŸºäºKey-Groupï¼Œå°†Key-Groupé‡æ–°åˆ†é…åˆ°å¹¶è¡ŒTaskä¸­ï¼Œå¹¶ä¸”è¿™ç§é‡æ–°åˆ†é…ä¸æ˜¯ä¸€ä¸ªShuffleï¼ŒKey-Groupå½’å±çš„å¹¶è¡ŒTaskçš„å˜æ›´å¾ˆå°ã€‚</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://wangyemao-github.github.io/post/hello-gridea/</id>
        <link href="https://wangyemao-github.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>